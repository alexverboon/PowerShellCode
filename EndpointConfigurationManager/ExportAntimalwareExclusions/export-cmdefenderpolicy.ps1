function Export-CMDefenderPolicy
{
<#
.Synopsis
   Export-CMDefenderPolicy
.DESCRIPTION
   Export-CMDefenderPolicy exports antimalware policies from Microsoft Endpoint Configuration Manager. Use this cmdlet
   to export all CM Antimalware policies and then export the exclusion settings.

    $ExportPath =  "C:\temp\defenderexclusion"
    Export-CMDefenderPolicy -Path $ExportPath -Verbose
    $CMAntimalwareFiles = Get-ChildItem -Path $ExportPath 

    $AllExclusions = ForEach($File in $CMAntimalwareFiles)
    {
        Export-CMExclusions -CMPolicyFile $File.FullName
    }

    $AllExclusions | Export-Csv -Path C:\temp\defenderexclusion\allexclusions.csv -NoClobber -NoTypeInformation

.EXAMPLE
   Export-CMDefenderPolicy -Path C:\temp\defenderexclusion
.NOTES
    v1.0, 20.05.2022, Alex Verboon
#>
    [CmdletBinding(SupportsShouldProcess=$true)]
        Param
    (
        # Export Path
        [Parameter(Mandatory=$false)]
        [ValidateNotNull()]
        [ValidateNotNullOrEmpty()]
        $Path
    )
    Begin
    {
         $AntimalwarePolicies = Get-CMAntimalwarePolicy 
    }
    Process
    {
        ForEach($policy in $AntimalwarePolicies)
        {
           if ($pscmdlet.ShouldProcess("$($policy.Name)", "Export"))
            {
                Write-Verbose $policy.name
                $ExportFilename = $($Policy.Name).Split([IO.Path]::GetInvalidFileNameChars()) -join '_'
                $ExportFilename = $($ExportFilename).Replace(" ","") + ".xml"
                If($policy.Name -eq "Default Client Antimalware Policy")
                {
                    # skipping the default client antimalware policy, having an issue with export here
                    # that I look at another time :-)
                }
                Else
                {
                    Export-CMAntimalwarePolicy -InputObject $policy -Path "$Path\$ExportFilename" 
                }
            }
        }
    }
    End
    {
    }
}

